{# users/templates/users/register.html #}
{% extends 'users/base.html' %}
{% load static %}

{% block title %}Register with PurPaws{% endblock %}

{% block body_class %}register-page-background{% endblock %}

{% block content %}
<section class="auth-section">
  <div class="auth-box">
    <h2 class="auth-title">Create Your Account</h2>
    <p class="auth-subtitle">Join our community to help pets find homes!</p>

    <form id="registrationForm" method="post" action="{% url 'users:register' %}">
      {% csrf_token %}

            <!-- ================= ERROR DISPLAY BLOCK ================= -->
      {% if form.errors %}
        <div class="alert alert-danger">
          <p><strong>Please correct the errors below:</strong></p>
          <ul>
          {% for field in form %}
            {% for error in field.errors %}
              <li>{{ field.label }}: {{ error }}</li>
            {% endfor %}
          {% endfor %}
          {# This shows errors not tied to a specific field, like passcode mismatch #}
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}
          </ul>
        </div>
      {% endif %}
      <!-- ======================================================== -->

      <!-- --- ALL FORM FIELDS GO HERE --- -->
      <div class="form-group">
        {{ form.username.label_tag }}
        {{ form.username }}
      </div>

      <div class="form-group">
        {{ form.email.label_tag }}
        {{ form.email }}
      </div>

      <div class="form-group">
        {{ form.first_name.label_tag }}
        {{ form.first_name }}
      </div>

      <div class="form-group">
        {{ form.age.label_tag }} 
        {{ form.age }}
      </div>

      <div class="form-group">
        {{ form.city.label_tag }} 
        {{ form.city }}
      </div>

      <div class="form-group">
        {{ form.phone_number.label_tag }} 
        {{ form.phone_number }}
      </div>

      <div class="form-group">
        {{ form.password.label_tag }}
        {{ form.password }}
        <small class="password-rules">Min 8 chars, 1 uppercase, 1 lowercase, 1 number, 1 special char.</small>
      </div>

      <div class="form-group">
        {{ form.password2.label_tag }}
        {{ form.password2 }}
      </div>
      <!-- ----------------------------------- -->

      <!-- --- Fields for Admin Registration --- -->
      <div class="form-group admin-toggle">
        <label for="{{ form.is_admin_registration.id_for_label }}">
          {{ form.is_admin_registration }}
          {{ form.is_admin_registration.label }}
        </label>
      </div>

      <div class="form-group" id="admin_passcode_group" style="display: none;">
        {{ form.admin_passcode.label_tag }}
        {{ form.admin_passcode }}
      </div>
      <!-- ----------------------------------- -->

      <button type="submit" class="btn btn-primary btn-full">Register</button>
    </form>

    <div class="auth-switch">
      <p>Already have an account? <a href="{% url 'users:login' %}" class="btn btn-small">Login Here</a></p>
    </div>
  </div>
</section>

{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const adminCheckbox = document.getElementById('{{ form.is_admin_registration.id_for_label }}');
  const passcodeGroup = document.getElementById('admin_passcode_group');

  // Function to toggle display
  function togglePasscodeField() {
    if (adminCheckbox && passcodeGroup) { // Check if elements exist
      if (adminCheckbox.checked) {
        passcodeGroup.style.display = 'block';
      } else {
        passcodeGroup.style.display = 'none';
      }
    }
  }

  // Initial check in case the form is re-rendered with the box already checked
  togglePasscodeField();

  // Add event listener if checkbox exists
  if (adminCheckbox) {
    adminCheckbox.addEventListener('change', togglePasscodeField);
  }
});
</script>
{% endblock %}